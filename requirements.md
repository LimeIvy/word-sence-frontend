# 📄 わ～どせんす 要件定義書

## 目次

1. [概要と目標](#1-概要と目標)
2. [カードとデッキの構造](#2-カードとデッキの構造)
3. [対戦フロー](#3-対戦フロー)
4. [レアリティとボーナスシステム](#4-レアリティとボーナスシステム)
5. [複数人対戦への拡張性](#5-複数人対戦への拡張性)
6. [経済・報酬システム](#6-経済報酬システム)
7. [UI/UX設計](#7-uiux設計)
8. [技術スタック](#8-技術スタック)
9. [エッジケースと例外処理](#9-エッジケースと例外処理)
10. [開発優先順位](#10-開発優先順位)

---

## 1. 概要と目標

### 1.1 基本情報

| 項目               | 内容                                                                                                     |
| ------------------ | -------------------------------------------------------------------------------------------------------- |
| **ゲーム名**       | ワードセンス                                                                                             |
| **ジャンル**       | 対戦型カードゲーム（心理戦・戦略）                                                                       |
| **基本コンセプト** | Word2Vecを活用した単語の意味的距離（コサイン類似度）バトル<br>心理戦・読み合い・デッキ構築の戦略性に集中 |
| **勝利条件**       | 先に**3ポイント**獲得したプレイヤーの勝利                                                                |
| **対戦人数**       | MVP: 2人対戦<br>将来: 3〜5人対戦                                                                         |
| **想定プレイ時間** | 1試合 5〜10分                                                                                            |

### 1.2 コアゲームループ

```
[マッチング]
    ↓
[ラウンド開始] ← 先に3点取った方の勝ち
    ↓
[お題カード提示]
    ↓
[アクションフェーズ（60秒）]
  - カード交換
  - 単語生成
  - 相手の手札を観察
    ↓
[提出フェーズ（30秒）]
  - カード選択
  - 通常提出 or 勝利宣言
    ↓
[対応フェーズ（20秒）]
  - 勝利宣言があればコール/フォールド判断
    ↓
[判定フェーズ（10秒）]
  - 類似度計算
  - ポイント付与
    ↓
[勝利判定]
  - 3ポイント先取で勝利
  - または次ラウンドへ
```

---

## 2. カードとデッキの構造

### 2.1 単語データソース

| 項目               | 詳細                      |
| ------------------ | ------------------------- |
| **データ元**       | 日本語版Wikipedia全データ |
| **単語数**         | 出現頻度上位**15,000語**  |
| **Word2Vecモデル** |                           |

### 2.2 レアリティ分類

| レアリティ     | アイコン | 排出率 |
| -------------- | -------- | ------ |
| **コモン**     | ★        | 50%    |
| **レア**       | ★★       | 30%    |
| **スーパーア** | ★★       | 15%    |
| **エピック**   | ★★★      | 4.5%   |
| **レジェンド** | ★★★★     | 0.5%   |

### 2.3 デッキ構築

| 項目           | 仕様                                   |
| -------------- | -------------------------------------- |
| **デッキ枚数** | 20枚（重複不可）                       |
| **編集場所**   | /deck                                  |
| **構築制限**   | なし（任意のレアリティ組み合わせ可能） |

### 2.4 手札システム

| 項目               | 仕様                                                     |
| ------------------ | -------------------------------------------------------- |
| **手札枚数**       | 常に5枚                                                  |
| **初期配布**       | ラウンド開始時にデッキから5枚                            |
| **情報公開**       | **相手の手札は常に全公開**（単語のみ、類似度は非表示）   |
| **ドロー優先順位** | 1. 自分のデッキ<br>2. デッキ枯渇時は全15,000語プールから |

### 2.5 お題カード

| 項目               | 仕様                                           |
| ------------------ | ---------------------------------------------- |
| **生成タイミング** | 各ラウンド開始時                               |
| **抽選方法**       | 全15,000語から出現頻度に基づく重み付けランダム |
| **表示情報**       | 単語テキスト                                   |

---

## 3. 対戦フロー

### 3.1 フェーズ構造（2人対戦版）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
フェーズ1: アクションフェーズ（60秒・同時進行）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
目的: 手札を強化し、最適な1枚を準備

できること:
• カード交換（1行動）
• 単語生成（1行動）
• 合計3回まで自由に行動可能

終了条件:
• 両者が「準備完了」
• または60秒経過

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
フェーズ2: 提出フェーズ（30秒・同時進行）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
目的: どのカードで勝負するかを決定

できること:
• 手札から1枚選択
• 「通常提出」or「勝利宣言」を選択
• 提出確定（変更不可）

終了条件:
• 両者が提出確定
• または30秒経過（自動ランダム提出）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
フェーズ3: 対応フェーズ（20秒・条件付き発動）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
発動条件: いずれかが「勝利宣言」した場合のみ

できること:
• 相手の勝利宣言に対して「コール」or「フォールド」

終了条件:
• 応答が完了
• または20秒経過（自動で「通常提出」扱い）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
フェーズ4: 判定フェーズ（10秒・演出）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
処理:
• コサイン類似度計算
• ボーナス適用
• ポイント付与
• アニメーション表示
```

### 3.2 アクションの詳細

#### 3.2.1 カード交換

```
手順:
1. 手札から0〜5枚を選択して破棄
2. ドロー元を選択（デッキ or 全プール）
3. 破棄した枚数と同じ枚数をドロー
4. 手札に追加

コスト: 1行動

ドロー元の違い:
┌────────────────┬────────────────┐
│ 🎴 デッキ      │ 🎲 全プール     │
├────────────────┼────────────────┤
│ ✅ レアが出やすい│ ✅ 枯渇しない   │
│ ✅ ボーナス対象 │ ❌ コモン70%    │
│ ❌ 枯渇する     │ ❌ ボーナスなし │
└────────────────┴────────────────┘

デッキ枯渇時:
• デッキ残り < 破棄枚数の場合
  → デッキから可能な限りドロー
  → 残りは全プールから自動ドロー
```

#### 3.2.2 単語生成

```
手順:
1. 手札から2〜3枚を選択
2. 「+ゾーン」「-ゾーン」に配置
   - +ゾーン: 意味を加算
   - -ゾーン: 意味を減算
3. ベクトル演算実行
4. 生成元カードを消費
5. 新カードを手札に追加

コスト: 1行動

```

### 3.3 提出とポイント計算

#### 3.3.1 提出の種類

| 提出タイプ   | 効果                                                                                                  |
| ------------ | ----------------------------------------------------------------------------------------------------- |
| **通常提出** | - 勝てば +1点<br>- 負ければ 0点<br>- ローリスク                                                       |
| **勝利宣言** | - 勝てば +2点<br>- 負ければ -2点<br>- 相手がフォールドすれば無条件 +1点<br>- ハイリスク・ハイリターン |

#### 3.3.2 ポイント計算表

| P1の宣言 | P2の応答   | 判定結果     | P1      | P2      |
| -------- | ---------- | ------------ | ------- | ------- |
| 勝利宣言 | コール     | P1勝利       | **+2**  | **-2**  |
| 勝利宣言 | コール     | P2勝利       | **-2**  | **+2**  |
| 勝利宣言 | コール     | 同点         | 0       | 0       |
| 勝利宣言 | フォールド | -            | **+1**  | 0       |
| 通常提出 | 通常提出   | 高スコア勝利 | +1 or 0 | +1 or 0 |
| 通常提出 | 通常提出   | 同点         | 0       | 0       |

#### 3.3.3 スコア計算式

```
最終スコア = 基本類似度 + レアリティボーナス

基本類似度:
cosine_similarity(提出カードベクトル, お題カードベクトル)
範囲: 0.0 〜 1.0

レアリティボーナス:
→ 詳細は「4. レアリティとボーナスシステム」参照
```

---

## 4. レアリティとボーナスシステム

### 4.1 ボーナスの基本ルール

```
提出時のボーナス条件:
1. 提出カードがデッキに入っていること
2. レアリティに応じたボーナス

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【直接提出の場合】
デッキカード × レアリティ = ボーナス

【生成後に提出の場合】
生成に使った全カードがデッキカード
× 最も高いレアリティ = ボーナス
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 4.2 レアリティ別ボーナス

| レアリティ    | デッキカード | ボーナス  |
| ------------- | ------------ | --------- |
| ⚪ コモン     | ✅ Yes       | +0.00     |
| 🔵 レア       | ✅ Yes       | **+0.03** |
| 🟣 エピック   | ✅ Yes       | **+0.05** |
| 🟠 レジェンド | ✅ Yes       | **+0.08** |
| 任意          | ❌ No        | +0.00     |

### 4.3 ボーナス適用例

#### 例1: 直接提出

```
お題: 【科学】
提出カード: [実験★★ (レア)] ← デッキカード
基本類似度: 0.82
レアボーナス: +0.03
━━━━━━━━━━━━━━━━━━━━━━━━
最終スコア: 0.85
```

#### 例2: 生成後に提出（全てデッキカード）

```
お題: 【科学】

生成素材:
• [実験★★ (レア)] ← デッキカード
• [理論★★★ (エピック)] ← デッキカード

生成結果: [科学★★]
基本類似度: 0.95
━━━━━━━━━━━━━━━━━━━━━━━━
最も高いレアリティ: エピック
ボーナス: +0.05
━━━━━━━━━━━━━━━━━━━━━━━━
最終スコア: 1.00（上限）
```

#### 例3: 生成後に提出（全プール混入）

```
お題: 【科学】

生成素材:
• [実験★★ (レア)] ← デッキカード
• [理論★★★ (エピック)] ← 全プールから

生成結果: [科学★★]
基本類似度: 0.95
━━━━━━━━━━━━━━━━━━━━━━━━
❌ 全てデッキカードではない
ボーナス: なし
━━━━━━━━━━━━━━━━━━━━━━━━
最終スコア: 0.95
```

### 4.4 重要な仕様

1. **生成されたカードはデッキカード扱いにならない**
   - 複数回生成を経たカードはボーナス対象外
2. **ボーナス判定は提出時のみ**
   - 生成時にはボーナスは適用されない
3. **複数枚使用時は最も高いレアリティ**
   - コモン + エピックで生成 → エピックのボーナス

---

## 5. 複数人対戦への拡張性

### 5.1 設計方針

```
2人対戦と3〜5人対戦で処理を統一
↓
「プレイヤーリスト」として扱う
↓
人数によって以下が自動調整される:
• UI配置
• 勝利宣言の処理
• ポイント計算
```

### 5.3 UI設計（人数対応）

#### 5.3.1 2人対戦レイアウト

```
┌─────────────────────────────────────────┐
│ 相手 ⭐⭐☆                              │
│ [手札5枚] ← 上部に配置                   │
├─────────────────────────────────────────┤
│                                         │
│        お題: 【科学】                    │
│                                         │
├─────────────────────────────────────────┤
│ [手札5枚] ← 下部に配置                   │
│ あなた ⭐⭐⭐                            │
└─────────────────────────────────────────┘
```

#### 5.3.2 3人対戦レイアウト（将来実装）

```
┌─────────────────────────────────────────┐
│      プレイヤー2 ⭐⭐☆                   │
│      [手札5枚] ← 上部中央                │
├─────────────────────────────────────────┤
│ プレイヤー3   お題: 【科学】   あなた    │
│ ⭐☆☆                        ⭐⭐⭐     │
│ [手札5枚]                   [手札5枚]   │
│   ↑左                           ↑右     │
└─────────────────────────────────────────┘
```

#### 5.3.3 4〜5人対戦レイアウト（将来実装）

```
        [P2 ⭐⭐]
            ↑
    [P3]  お題  [あなた]
     ←   【科学】   →
        [P4 ⭐☆]
            ↓
```

### 5.4 勝利宣言システム（複数人対応）

#### 5.4.1 2人対戦の場合（現在）

```
P1が勝利宣言
  ↓
P2が「コール」or「フォールド」を選択
  ↓
判定
```

#### 5.4.2 複数人対戦の場合（将来）

```
誰か1人が勝利宣言
  ↓
他の全プレイヤーが選択:
• コール（勝負を受ける）
• フォールド（降りる）
  ↓
コールしたプレイヤーのみで判定
  ↓
ポイント配分:
• 勝利宣言者が最高スコア → +2点
• 勝利宣言者が負け → -2点
• フォールド者 → 0点
```

#### 例: 4人対戦で勝利宣言

```
P1: 勝利宣言
P2: コール
P3: フォールド
P4: コール

結果: P1のスコアが最高
  ↓
P1: +2点
P2: -2点
P3: 0点
P4: -2点
```

---

## 6. 経済・報酬システム

### 6.1 ゲーム内通貨「ジェム」

| 獲得方法         | 獲得量                          |
| ---------------- | ------------------------------- |
| 初回ログイン     | 1,000ジェム                     |
| 対戦勝利         | 100ジェム/勝                    |
| デイリーログイン | 50ジェム/日                     |
| カード分解       | レアリティに応じて10〜100ジェム |

### 6.2 ガチャシステム

| 種類        | コスト     | 内容                   |
| ----------- | ---------- | ---------------------- |
| 10連ガチャ  | 100ジェム  | 10枚                   |
| 100連ガチャ | 1000ジェム | 100枚、レア以上1枚確定 |

**排出率**:

- コモン: 50%
- レア: 30%
- スーパーレア： 15%
- エピック: 4.5%
- レジェンド: 0.5%

### 6.3 マーケット

| 機能       | 詳細                         |
| ---------- | ---------------------------- |
| **出品**   | プレイヤーが価格設定して出品 |
| **購入**   | ジェムで直接購入             |
| **手数料** | なし（売上全額が出品者へ）   |

---

## 7. UI/UX設計

### 7.1 主要画面一覧

1. **ホーム画面**
   - 対戦開始
   - デッキ編集
   - ショップ
   - ランキング

2. **デッキ編集画面**
   - 20枚選択
   - フィルタ・検索
   - プリセット選択

3. **対戦画面**
   - お題表示
   - 手札表示
   - アクションボタン
   - ポイント表示

4. **結果画面**
   - 勝敗表示
   - 獲得ジェム
   - 統計情報

### 7.2 アクションフェーズUI

```
┌─────────────────────────────────────────┐
│ ⏱️ 45秒  お題: 【科学】                   │
│ 残り行動回数: ⭐⭐⭐                      │
├─────────────────────────────────────────┤
│ 【相手の手札】                           │
│ [研究★★] [分析★★] [データ★★] ...      │
│ 💭 相手の行動: カード交換 2回            │
├─────────────────────────────────────────┤
│ 【あなたの手札】                         │
│ ┌─────┐┌─────┐┌─────┐           │
│ │実験★★││理論★★★││愛★   ││           │
│ │0.82  ││0.75  ││0.15  ││           │
│ │🎴デッキ││🎴デッキ││🎲Pool││           │
│ └─────┘└─────┘└─────┘           │
│                                         │
│ [🔄 カード交換] [⚗️ 単語生成] [✅ 提出]  │
│                                         │
│ 🎴 デッキ残り: 12/20                     │
└─────────────────────────────────────────┘
```

### 7.3 提出フェーズUI

```
┌─────────────────────────────────────────┐
│ ⏱️ 20秒  提出するカードを選択             │
├─────────────────────────────────────────┤
│ ┌──────────┐ ┌──────────┐ ┌──────────┐│
│ │ 実験★★   │ │ 理論★★★ │ │ 進化★★   ││
│ │          │ │          │ │          ││
│ │ 類似度:   │ │ 類似度:   │ │ 類似度:  ││
│ │ 0.82     │ │ 0.75     │ │ 0.70     ││
│ │          │ │          │ │          ││
│ │ 🎴デッキ  │ │ 🎴デッキ  │ │ 🎴デッキ  ││
│ │ +0.03    │ │ +0.05    │ │ +0.03    ││
│ │          │ │          │ │          ││
│ │ 最終:     │ │ 最終:     │ │ 最終:    ││
│ │ 0.85 ✨  │ │ 0.80     │ │ 0.73     ││
│ └──────────┘ └──────────┘ └──────────┘│
├─────────────────────────────────────────┤
│ 宣言タイプ:                              │
│ [ 📄 通常提出 ]  [ ⚡ 勝利宣言 ]         │
│                                         │
│ [🔒 提出を確定する]                      │
└─────────────────────────────────────────┘
```

---

## 8. 技術スタック

### 8.1 システム構成

```
[フロントエンド]
  Next.js 15 (App Router)
  TypeScript
  Tailwind CSS

[バックエンド]
  Convex (DB + リアルタイム通信)

[ベクトル計算]
  FastAPI
  NumPy
  gensim (Word2Vec)
```

## 9. エッジケースと例外処理

### 9.1 通信エラー

| ケース                     | 処理                            |
| -------------------------- | ------------------------------- |
| アクションフェーズ中に切断 | 60秒待機 → 再接続なければ不戦敗 |
| 提出フェーズ以降に切断     | タイムアウト処理適用            |
| 3回以上の切断              | ペナルティ -1ポイント           |

### 9.2 タイムアウト処理

| フェーズ           | タイムアウト時の挙動                   |
| ------------------ | -------------------------------------- |
| アクションフェーズ | 強制的に次フェーズへ                   |
| 提出フェーズ       | ランダムなカードで「通常提出」         |
| 対応フェーズ       | 「通常提出」扱い（フォールドではない） |

### 9.3 同点判定

| 状況               | 処理                            |
| ------------------ | ------------------------------- |
| 類似度が完全同値   | 両者0点、次ラウンドへ           |
| 勝利宣言同士で同点 | 両者0点                         |
| 3-3の同点          | 延長戦（先に1点取った方の勝ち） |

### 9.4 デッキ枯渇

| 状況                 | 処理                                      |
| -------------------- | ----------------------------------------- |
| 交換でデッキ残り不足 | デッキから可能な限り + 残りは全プールから |
| デッキ完全枯渇       | 「🎴デッキ」ボタンをグレーアウト          |
| 手札5枚未満          | 自動的に全プールから補充                  |

---

## 10. 開発優先順位

```
Priority 1（必須）:
✅ 2人対戦の基本機能
✅ カード交換・単語生成
✅ 勝利宣言システム
✅ ガチャ
✅ レアリティボーナス
✅ デッキ編集
✅ マーケット

Priority 2（あったらいい）:
• ランキング
• 基本的なチュートリアル

```
